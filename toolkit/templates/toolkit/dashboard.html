<!DOCTYPE html>
<html lang="en">

<head>
    <title>Incident Response</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/luxon@3.0.1"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon@1.2.0"></script>
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.6.1/css/all.css" integrity="sha384-gfdkjb5BdAXd+lj+gudLWI+BXq4IuLW5IT+brZEZsLFm++aCMlF1V92rMkPaX4PP" crossorigin="anonymous">

    <style>
        :root {
            --primary-color: #1c3d5a;
            --secondary-color: #296c83;
            --accent-color: #3a9db5;
            --light-color: #f8f9fa;
            --dark-color: #333;
            --success-color: #4caf50;
            --warning-color: #ff9800;
            --danger-color: #f44336;
            --border-radius: 12px;
            --box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            --transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        }

        body,
        html {
            margin: 0;
            padding: 0;
            height: 100%;
            background: #f5f7fa !important;
            font-family: 'Segoe UI', 'Roboto', 'Helvetica Neue', sans-serif;
            color: var(--dark-color);
            line-height: 1.6;
        }

        .top-bar {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            position: relative;
            z-index: 100;
        }

        .top-bar h3 {
            margin: 0;
            font-size: 1.5rem;
            font-weight: 600;
            display: flex;
            align-items: center;
        }

        .top-bar h3 i {
            margin-right: 12px;
            font-size: 1.3rem;
        }

        .top-bar .buttons {
            display: flex;
            gap: 15px;
        }

        .top-bar .buttons a {
            background: rgba(255, 255, 255, 0.9);
            color: var(--primary-color);
            border: none;
            border-radius: 30px;
            padding: 8px 20px;
            font-weight: 600;
            text-decoration: none;
            transition: var(--transition);
            display: flex;
            align-items: center;
            box-shadow: var(--box-shadow);
        }

        .top-bar .buttons a i {
            margin-right: 8px;
        }

        .top-bar .buttons a:hover {
            background: white;
            color: var(--secondary-color);
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.12);
        }

        .dashboard-container {
            padding: 25px;
            display: flex;
            flex-direction: column;
            gap: 25px;
            max-width: 1800px;
            margin: 0 auto;
        }

        .dashboard-layout {
            display: grid;
            grid-template-columns: 1fr 1.5fr;
            gap: 25px;
        }

        .alerts-column {
            display: flex;
            flex-direction: column;
            gap: 25px;
        }

        .graphs-column {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
        }

        .section {
            background: white;
            border-radius: var(--border-radius);
            padding: 20px;
            box-shadow: var(--box-shadow);
            transition: var(--transition);
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        .section:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        }

        .section-header h4 {
            color: var(--primary-color);
            font-weight: 600;
            margin: 0;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
        }

        .section-header h4 i {
            margin-right: 10px;
            color: var(--accent-color);
        }

        .section-header .badge {
            background: var(--accent-color);
            color: white;
            font-weight: 500;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.75rem;
        }

        .button-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .button-section a {
            padding: 25px 15px;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            text-align: center;
            font-size: 1rem;
            font-weight: 600;
            border-radius: var(--border-radius);
            text-decoration: none;
            box-shadow: var(--box-shadow);
            transition: var(--transition);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .button-section a i {
            font-size: 2rem;
            margin-bottom: 12px;
        }

        .button-section a:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
            background: linear-gradient(135deg, var(--secondary-color), var(--accent-color));
        }

        .table-container {
            flex: 1;
            overflow: hidden;
            border-radius: calc(var(--border-radius) - 5px);
        }

        .scrollable-table {
            max-height: 300px;
            overflow-y: auto;
        }

        .table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            font-size: 0.9rem;
        }

        .table th {
            position: sticky;
            top: 0;
            background: var(--primary-color);
            color: white;
            font-weight: 500;
            padding: 12px 15px;
        }

        .table td {
            padding: 12px 15px;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        }

        .table tr:last-child td {
            border-bottom: none;
        }

        .table tbody tr:hover {
            background-color: rgba(28, 61, 90, 0.05);
        }

        .empty-row {
            text-align: center;
            color: #888;
            padding: 20px;
        }

        .metric-card {
            background: white;
            border-radius: var(--border-radius);
            padding: 20px;
            box-shadow: var(--box-shadow);
            display: flex;
            flex-direction: column;
            transition: var(--transition);
        }

        .metric-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
        }

        .metric-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .metric-title {
            font-size: 0.9rem;
            color: var(--primary-color);
            font-weight: 600;
            display: flex;
            align-items: center;
        }

        .metric-title i {
            margin-right: 8px;
            color: var(--accent-color);
        }

        .metric-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 5px;
        }

        .metric-change {
            font-size: 0.8rem;
            display: flex;
            align-items: center;
        }

        .metric-change.positive {
            color: var(--success-color);
        }

        .metric-change.negative {
            color: var(--danger-color);
        }

        .metric-change i {
            margin-right: 4px;
        }

        .graph-container {
            position: relative;
            height: 200px;
            width: 100%;
            margin-top: 10px;
        }

        footer {
            background: var(--primary-color);
            color: white;
            text-align: center;
            padding: 15px 0;
            margin-top: 30px;
            font-size: 0.85rem;
        }

        footer a {
            color: var(--accent-color);
            text-decoration: none;
            transition: color 0.3s ease;
        }

        footer a:hover {
            color: white;
        }

        .status-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .status-badge.alert {
            background: rgba(244, 67, 54, 0.1);
            color: var(--danger-color);
        }

        .status-badge.warning {
            background: rgba(255, 152, 0, 0.1);
            color: var(--warning-color);
        }

        .status-badge.normal {
            background: rgba(76, 175, 80, 0.1);
            color: var(--success-color);
        }

        .scrollable-content {
            flex: 1;
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: rgba(28, 61, 90, 0.3) transparent;
        }

        .scrollable-content::-webkit-scrollbar {
            width: 6px;
        }

        .scrollable-content::-webkit-scrollbar-track {
            background: transparent;
        }

        .scrollable-content::-webkit-scrollbar-thumb {
            background-color: rgba(28, 61, 90, 0.3);
            border-radius: 3px;
        }

        .quick-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .quick-stat {
            background: white;
            border-radius: var(--border-radius);
            padding: 20px;
            box-shadow: var(--box-shadow);
            display: flex;
            align-items: center;
            transition: var(--transition);
        }

        .quick-stat:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 18px rgba(0, 0, 0, 0.1);
        }

        .quick-stat-icon {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: rgba(58, 157, 181, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            color: var(--accent-color);
            font-size: 1.2rem;
        }

        .quick-stat-info {
            flex: 1;
        }

        .quick-stat-title {
            font-size: 0.8rem;
            color: #666;
            margin-bottom: 5px;
        }

        .quick-stat-value {
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--primary-color);
        }

        .quick-stat-change {
            font-size: 0.75rem;
            color: #666;
            display: flex;
            align-items: center;
        }

        .quick-stat-change.positive {
            color: var(--success-color);
        }

        .quick-stat-change.negative {
            color: var(--danger-color);
        }

        @media (max-width: 1200px) {
            .dashboard-layout {
                grid-template-columns: 1fr;
            }

            .graphs-column {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .top-bar {
                flex-direction: column;
                align-items: flex-start;
                padding: 15px;
            }

            .top-bar .buttons {
                margin-top: 15px;
                width: 100%;
                justify-content: space-between;
            }

            .quick-stats {
                grid-template-columns: 1fr 1fr;
            }

            .button-section {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 480px) {
            .quick-stats {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>

<body>
    <!-- Top Bar -->
    <div class="top-bar">
        <div>
            <h3><i class="fas fa-shield-alt"></i> Incident Response Dashboard</h3>
        </div>
        <div class="buttons">
            <a href="{% url 'registration' %}"><i class="fas fa-user-plus"></i> New User</a>
            <a href="{% url 'logout' %}"><i class="fas fa-sign-out-alt"></i> Logout</a>
        </div>
    </div>

    <!-- Dashboard Content -->
    <div class="dashboard-container">
        <!-- Quick Stats -->
        <div class="quick-stats">
            <div class="quick-stat">
                <div class="quick-stat-icon">
                    <i class="fas fa-exclamation-triangle"></i>
                </div>
                <div class="quick-stat-info">
                    <div class="quick-stat-title">Critical Alerts</div>
                    <div class="quick-stat-value">12</div>
                    <div class="quick-stat-change positive">
                        <i class="fas fa-arrow-down"></i> 2% from yesterday
                    </div>
                </div>
            </div>
            <div class="quick-stat">
                <div class="quick-stat-icon">
                    <i class="fas fa-network-wired"></i>
                </div>
                <div class="quick-stat-info">
                    <div class="quick-stat-title">Network Threats</div>
                    <div class="quick-stat-value">8</div>
                    <div class="quick-stat-change negative">
                        <i class="fas fa-arrow-up"></i> 15% from yesterday
                    </div>
                </div>
            </div>
            <div class="quick-stat">
                <div class="quick-stat-icon">
                    <i class="fas fa-bug"></i>
                </div>
                <div class="quick-stat-info">
                    <div class="quick-stat-title">Malware Detected</div>
                    <div class="quick-stat-value">3</div>
                    <div class="quick-stat-change">
                        No change
                    </div>
                </div>
            </div>
            <div class="quick-stat">
                <div class="quick-stat-icon">
                    <i class="fas fa-clock"></i>
                </div>
                <div class="quick-stat-info">
                    <div class="quick-stat-title">Avg. Response Time</div>
                    <div class="quick-stat-value">24m</div>
                    <div class="quick-stat-change positive">
                        <i class="fas fa-arrow-down"></i> 8% from last week
                    </div>
                </div>
            </div>
        </div>

        <!-- Button Section -->
        <div class="button-section">
            <a href="{% url 'log_analysis' %}">
                <i class="fas fa-search"></i>
                Log Analysis
            </a>
            <a href="{% url 'network_analysis' %}">
                <i class="fas fa-network-wired"></i>
                Network Analysis
            </a>
            <a href="{% url 'malware_detection' %}">
                <i class="fas fa-bug"></i>
                Malware Detection
            </a>
        </div>

        <!-- Main Content Layout -->
        <div class="dashboard-layout">
            <!-- Left Column - Alerts and Watchlist -->
            <div class="alerts-column">
                <!-- Alerts Section -->
                <div class="section">
                    <div class="section-header">
                        <h4><i class="fas fa-exclamation-circle"></i> All Alerts</h4>
                        <span class="badge">12 New</span>
                    </div>
                    <div class="table-container scrollable-table">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Timestamp</th>
                                    <th>Message</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for log in alert_logs %}
                                    <tr>
                                        <td>{{ log.timeStamp }}</td>
                                        <td>{{ log.message }}</td>
                                        <td>
                                            <span class="status-badge
                                                {% if 'critical' in log.message|lower %}alert
                                                {% elif 'warning' in log.message|lower %}warning
                                                {% else %}normal{% endif %}">
                                                {% if 'critical' in log.message|lower %}Critical
                                                {% elif 'warning' in log.message|lower %}Warning
                                                {% else %}Normal{% endif %}
                                            </span>
                                        </td>
                                    </tr>
                                {% empty %}
                                    <tr>
                                        <td colspan="3" class="empty-row">No alert logs available</td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Watch List Section -->
                <div class="section">
                    <div class="section-header">
                        <h4><i class="fas fa-eye"></i> Watch List</h4>
                        <span class="badge">Monitoring</span>
                    </div>
                    <div class="table-container scrollable-table">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Timestamp</th>
                                    <th>Message</th>
                                    <th>Severity</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for log in watch_list_logs %}
                                    <tr>
                                        <td>{{ log.timeStamp }}</td>
                                        <td>{{ log.message }}</td>
                                        <td>
                                            <span class="status-badge
                                                {% if 'high' in log.message|lower %}alert
                                                {% elif 'medium' in log.message|lower %}warning
                                                {% else %}normal{% endif %}">
                                                {% if 'high' in log.message|lower %}High
                                                {% elif 'medium' in log.message|lower %}Medium
                                                {% else %}Low{% endif %}
                                            </span>
                                        </td>
                                    </tr>
                                {% empty %}
                                    <tr>
                                        <td colspan="3" class="empty-row">No logs available in watch list</td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Right Column - Graphs -->
            <div class="graphs-column">
                <!-- RAM Usage Section -->
                <div class="section">
                    <div class="section-header">
                        <h4><i class="fas fa-memory"></i> Application RAM</h4>
                        <div class="metric-value">{{ latest_ram|floatformat:1 }} MB</div>
                    </div>
                    <div class="metric-change positive">
                        <i class="fas fa-arrow-down"></i> 5% from last hour
                    </div>
                    <div class="graph-container">
                        <canvas id="ramChart"></canvas>
                    </div>
                </div>

                <!-- CPU Usage Section -->
                <div class="section">
                    <div class="section-header">
                        <h4><i class="fas fa-microchip"></i> Application CPU</h4>
                        <div class="metric-value">{{ latest_cpu|floatformat:1 }}%</div>
                    </div>
                    <div class="metric-change negative">
                        <i class="fas fa-arrow-up"></i> 12% from last hour
                    </div>
                    <div class="graph-container">
                        <canvas id="cpuChart"></canvas>
                    </div>
                </div>

                <!-- Disk Read Section -->
                <div class="section">
                    <div class="section-header">
                        <h4><i class="fas fa-hdd"></i> Disk Read</h4>
                        <div class="metric-value">{{ latest_disk_read|floatformat:1 }} MB</div>
                    </div>
                    <div class="metric-change">
                        No significant change
                    </div>
                    <div class="graph-container">
                        <canvas id="diskReadChart"></canvas>
                    </div>
                </div>

                <!-- Disk Write Section -->
                <div class="section">
                    <div class="section-header">
                        <h4><i class="fas fa-hdd"></i> Disk Write</h4>
                        <div class="metric-value">{{ latest_disk_write|floatformat:1 }} MB</div>
                    </div>
                    <div class="metric-change positive">
                        <i class="fas fa-arrow-down"></i> 8% from last hour
                    </div>
                    <div class="graph-container">
                        <canvas id="diskWriteChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer>
        <p>&copy; 2023 Incident Response System. All rights reserved. | <a href="#">Privacy Policy</a> | <a href="#">Terms of Service</a></p>
    </footer>

    <script>
            // Store chart instances globally
            let ramChart, cpuChart, diskReadChart, diskWriteChart;
            let socket;

            document.addEventListener('DOMContentLoaded', function() {
                // Check if Chart.js is loaded
                if (typeof Chart === 'undefined') {
                    console.error('Chart.js is not loaded!');
                    return;
                }

                // Chart configuration - now only displays data from WebSocket
                const chartConfig = {
                    type: 'line',
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        animation: {
                            duration: 0
                        },
                        scales: {
                            x: {
                                type: 'time',
                                time: {
                                    unit: 'minute',
                                    displayFormats: {
                                        minute: 'HH:mm'
                                    }
                                },
                                grid: {
                                    display: false
                                },
                                ticks: {
                                    maxRotation: 0,
                                    autoSkip: true,
                                    maxTicksLimit: 6
                                }
                            },
                            y: {
                                beginAtZero: true,
                                grid: {
                                    color: 'rgba(0, 0, 0, 0.05)'
                                },
                                ticks: {
                                    maxTicksLimit: 5
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                mode: 'index',
                                intersect: false,
                                callbacks: {
                                    label: function(context) {
                                        return `${context.dataset.label}: ${context.parsed.y.toFixed(1)} ${context.dataset.unit || ''}`;
                                    }
                                }
                            }
                        },
                        elements: {
                            line: {
                                tension: 0.1,
                                borderWidth: 2
                            },
                            point: {
                                radius: 0,
                                hoverRadius: 5
                            }
                        },
                        interaction: {
                            mode: 'nearest',
                            axis: 'x',
                            intersect: false
                        }
                    }
                };

                // Initialize all charts with empty datasets
                function initializeCharts() {
                    // RAM Chart
                    const ramCtx = document.getElementById('ramChart').getContext('2d');
                    ramChart = new Chart(ramCtx, {
                        ...chartConfig,
                        data: {
                            datasets: [{
                                label: 'RAM Usage',
                                data: [], // Empty initial data
                                borderColor: 'rgb(58, 157, 181)',
                                backgroundColor: 'rgba(58, 157, 181, 0.1)',
                                fill: true,
                                unit: 'MB'
                            }]
                        }
                    });

                    // CPU Chart
                    const cpuCtx = document.getElementById('cpuChart').getContext('2d');
                    cpuChart = new Chart(cpuCtx, {
                        ...chartConfig,
                        data: {
                            datasets: [{
                                label: 'CPU Usage',
                                data: [], // Empty initial data
                                borderColor: 'rgb(244, 67, 54)',
                                backgroundColor: 'rgba(244, 67, 54, 0.1)',
                                fill: true,
                                unit: '%'
                            }]
                        }
                    });

                    // Disk Read Chart
                    const diskReadCtx = document.getElementById('diskReadChart').getContext('2d');
                    diskReadChart = new Chart(diskReadCtx, {
                        ...chartConfig,
                        data: {
                            datasets: [{
                                label: 'Disk Read',
                                data: [], // Empty initial data
                                borderColor: 'rgb(76, 175, 80)',
                                backgroundColor: 'rgba(76, 175, 80, 0.1)',
                                fill: true,
                                unit: 'MB'
                            }]
                        }
                    });

                    // Disk Write Chart
                    const diskWriteCtx = document.getElementById('diskWriteChart').getContext('2d');
                    diskWriteChart = new Chart(diskWriteCtx, {
                        ...chartConfig,
                        data: {
                            datasets: [{
                                label: 'Disk Write',
                                data: [], // Empty initial data
                                borderColor: 'rgb(255, 152, 0)',
                                backgroundColor: 'rgba(255, 152, 0, 0.1)',
                                fill: true,
                                unit: 'MB'
                            }]
                        }
                    });
                }

                // Connect to WebSocket
                function connectWebSocket() {
                    const wsScheme = window.location.protocol === "https:" ? "wss" : "ws";
                    const wsPath = wsScheme + "://" + window.location.host + "/ws/resources/";
                    socket = new WebSocket(wsPath);

                    socket.onopen = function() {
                        console.log('WebSocket connected');
                        // Request initial data
                        socket.send(JSON.stringify({type: 'get_initial_data'}));
                    };

                    socket.onmessage = function(event) {
                        try {
                            const data = JSON.parse(event.data);
                            if (!data) return;

                            if (data.type === 'initial_data') {
                                // Load initial data from database
                                loadInitialData(data);
                            }
                            else if (data.type === 'resource.update') {
                                // Process real-time update from database
                                updateCharts(data);
                            }
                        } catch (e) {
                            console.error('Error processing message:', e);
                        }
                    };

                    socket.onerror = function(error) {
                        console.error('WebSocket error:', error);
                    };

                    socket.onclose = function() {
                        console.log('WebSocket disconnected. Reconnecting...');
                        setTimeout(connectWebSocket, 3000);
                    };
                }

                // Update charts with new data from WebSocket
                function updateCharts(data) {
                    const timestamp = new Date(data.timestamp).getTime();

                    // Update RAM Chart with database data
                    if (ramChart) {
                        ramChart.data.datasets[0].data.push({
                            x: timestamp,
                            y: data.ram_used
                        });
                        // Keep only last 30 data points
                        if (ramChart.data.datasets[0].data.length > 30) {
                            ramChart.data.datasets[0].data.shift();
                        }
                        ramChart.update();
                        document.querySelector('.section:nth-child(1) .metric-value').textContent =
                            `${data.ram_used.toFixed(1)} MB`;
                    }

                    // Update CPU Chart with database data
                    if (cpuChart) {
                        cpuChart.data.datasets[0].data.push({
                            x: timestamp,
                            y: data.cpu_usage
                        });
                        if (cpuChart.data.datasets[0].data.length > 30) {
                            cpuChart.data.datasets[0].data.shift();
                        }
                        cpuChart.update();
                        document.querySelector('.section:nth-child(2) .metric-value').textContent =
                            `${data.cpu_usage.toFixed(1)}%`;
                    }

                    // Update Disk Read Chart with database data
                    if (diskReadChart) {
                        diskReadChart.data.datasets[0].data.push({
                            x: timestamp,
                            y: data.disk_read
                        });
                        if (diskReadChart.data.datasets[0].data.length > 30) {
                            diskReadChart.data.datasets[0].data.shift();
                        }
                        diskReadChart.update();
                        document.querySelector('.section:nth-child(3) .metric-value').textContent =
                            `${data.disk_read.toFixed(1)} MB`;
                    }

                    // Update Disk Write Chart with database data
                    if (diskWriteChart) {
                        diskWriteChart.data.datasets[0].data.push({
                            x: timestamp,
                            y: data.disk_write
                        });
                        if (diskWriteChart.data.datasets[0].data.length > 30) {
                            diskWriteChart.data.datasets[0].data.shift();
                        }
                        diskWriteChart.update();
                        document.querySelector('.section:nth-child(4) .metric-value').textContent =
                            `${data.disk_write.toFixed(1)} MB`;
                    }
                }

                // Load initial data from database
                function loadInitialData(data) {
                    // RAM Data
                    if (data.ram_data && ramChart) {
                        ramChart.data.datasets[0].data = data.ram_data.map(item => ({
                            x: new Date(item.timestamp).getTime(),
                            y: item.value
                        }));
                        ramChart.update();
                        if (data.ram_data.length > 0) {
                            document.querySelector('.section:nth-child(1) .metric-value').textContent =
                                `${data.ram_data[data.ram_data.length-1].value.toFixed(1)} MB`;
                        }
                    }

                    // CPU Data
                    if (data.cpu_data && cpuChart) {
                        cpuChart.data.datasets[0].data = data.cpu_data.map(item => ({
                            x: new Date(item.timestamp).getTime(),
                            y: item.value
                        }));
                        cpuChart.update();
                        if (data.cpu_data.length > 0) {
                            document.querySelector('.section:nth-child(2) .metric-value').textContent =
                                `${data.cpu_data[data.cpu_data.length-1].value.toFixed(1)}%`;
                        }
                    }

                    // Disk Read Data
                    if (data.disk_read_data && diskReadChart) {
                        diskReadChart.data.datasets[0].data = data.disk_read_data.map(item => ({
                            x: new Date(item.timestamp).getTime(),
                            y: item.value
                        }));
                        diskReadChart.update();
                        if (data.disk_read_data.length > 0) {
                            document.querySelector('.section:nth-child(3) .metric-value').textContent =
                                `${data.disk_read_data[data.disk_read_data.length-1].value.toFixed(1)} MB`;
                        }
                    }

                    // Disk Write Data
                    if (data.disk_write_data && diskWriteChart) {
                        diskWriteChart.data.datasets[0].data = data.disk_write_data.map(item => ({
                            x: new Date(item.timestamp).getTime(),
                            y: item.value
                        }));
                        diskWriteChart.update();
                        if (data.disk_write_data.length > 0) {
                            document.querySelector('.section:nth-child(4) .metric-value').textContent =
                                `${data.disk_write_data[data.disk_write_data.length-1].value.toFixed(1)} MB`;
                        }
                    }
                }

                // Initialize everything
                initializeCharts();
                connectWebSocket();

                // Clean up on page unload
                window.addEventListener('beforeunload', function() {
                    if (socket) socket.close();
                    if (ramChart) ramChart.destroy();
                    if (cpuChart) cpuChart.destroy();
                    if (diskReadChart) diskReadChart.destroy();
                    if (diskWriteChart) diskWriteChart.destroy();
                });
            });
        </script>
</body>
</html>