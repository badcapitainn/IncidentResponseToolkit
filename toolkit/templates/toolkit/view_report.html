<!-- toolkit/templates/toolkit/view_report.html -->
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>{{ report.title }}</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
      .report-header {
        background-color: #f8f9fa;
        border-radius: 10px;
        padding: 2rem;
        margin-bottom: 2rem;
      }
      .stat-card {
        border-radius: 8px;
        overflow: hidden;
        transition: transform 0.3s;
      }
      .stat-card:hover {
        transform: translateY(-3px);
      }
      .chart-container {
        position: relative;
        height: 300px;
        margin-bottom: 2rem;
      }
      .threat-item {
        border-left: 4px solid transparent;
        transition: all 0.3s;
      }
      .threat-item:hover {
        background-color: #f8f9fa;
      }
      .severity-badge {
        font-size: 0.8rem;
        padding: 0.35em 0.65em;
      }
      .severity-critical {
        background-color: #dc3545;
        border-left-color: #dc3545;
      }
      .severity-high {
        background-color: #fd7e14;
        border-left-color: #fd7e14;
      }
      .severity-medium {
        background-color: #ffc107;
        border-left-color: #ffc107;
        color: #212529;
      }
      .severity-low {
        background-color: #6c757d;
        border-left-color: #6c757d;
      }
    </style>
  </head>
  <body>
    <div class="container py-4">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h3">{{ report.title }}</h1>
        <div>
          <a
            href="{% url 'reports_dashboard' %}"
            class="btn btn-outline-secondary me-2"
          >
            <i class="bi bi-arrow-left"></i> Back to Reports
          </a>
          <a
            href="{% url 'download_report' report.id %}"
            class="btn btn-primary"
          >
            <i class="bi bi-download"></i> Download PDF
          </a>
        </div>
      </div>

      <div class="report-header">
        <div class="row">
          <div class="col-md-4">
            <p class="mb-1"><strong>Report Type:</strong></p>
            <p>{{ report.get_report_type_display }}</p>
          </div>
          <div class="col-md-4">
            <p class="mb-1"><strong>Date Range:</strong></p>
            <p>
              {{ report.start_date|date:"M d, Y" }} - {{ report.end_date|date:"M
              d, Y" }}
            </p>
          </div>
          <div class="col-md-4">
            <p class="mb-1"><strong>Generated By:</strong></p>
            <p>
              {{ report.generated_by.username }} on {{
              report.generated_at|date:"M d, Y H:i" }}
            </p>
          </div>
        </div>
      </div>

      {% if report.report_type == 'THREAT_SUMMARY' %}
      <!-- Threat Summary Report Content -->
      <div class="row mb-4">
        <div class="col-md-4 mb-3">
          <div class="card stat-card h-100 bg-primary text-white">
            <div class="card-body">
              <h5 class="card-title">Total Threats Detected</h5>
              <p class="display-4">
                {{
                report.data.malware.malicious_count|add:report.data.network.total_alerts|add:report.data.logs.total_alerts
                }}
              </p>
            </div>
          </div>
        </div>
        <div class="col-md-4 mb-3">
          <div class="card stat-card h-100 bg-success text-white">
            <div class="card-body">
              <h5 class="card-title">Malware Detected</h5>
              <p class="display-4">{{ report.data.malware.malicious_count }}</p>
            </div>
          </div>
        </div>
        <div class="col-md-4 mb-3">
          <div class="card stat-card h-100 bg-danger text-white">
            <div class="card-body">
              <h5 class="card-title">Network Alerts</h5>
              <p class="display-4">{{ report.data.network.total_alerts }}</p>
            </div>
          </div>
        </div>
      </div>

      <div class="row">
        <div class="col-md-6">
          <div class="card mb-4">
            <div class="card-header">
              <h5 class="mb-0">Malware Detection by Type</h5>
            </div>
            <div class="card-body">
              <div class="chart-container">
                <canvas id="malwareTypeChart"></canvas>
              </div>
            </div>
          </div>
        </div>
        <div class="col-md-6">
          <div class="card mb-4">
            <div class="card-header">
              <h5 class="mb-0">Network Alerts by Severity</h5>
            </div>
            <div class="card-body">
              <div class="chart-container">
                <canvas id="networkSeverityChart"></canvas>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="row">
        <div class="col-md-6">
          <div class="card mb-4">
            <div class="card-header">
              <h5 class="mb-0">Top Malicious Sources</h5>
            </div>
            <div class="card-body">
              <div class="chart-container">
                <canvas id="sourceIpChart"></canvas>
              </div>
            </div>
          </div>
        </div>
        <div class="col-md-6">
          <div class="card mb-4">
            <div class="card-header">
              <h5 class="mb-0">Log Alerts by Level</h5>
            </div>
            <div class="card-body">
              <div class="chart-container">
                <canvas id="logLevelChart"></canvas>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="card mb-4">
        <div class="card-header">
          <h5 class="mb-0">Recent Security Activities</h5>
        </div>
        <div class="card-body p-0">
          <div class="list-group list-group-flush">
            {% for activity in report.data.activities %}
            <div class="list-group-item threat-item">
              <div class="d-flex w-100 justify-content-between">
                <h6 class="mb-1">{{ activity.activity }}</h6>
                <small>{{ activity.timestamp|date:"M d, H:i" }}</small>
              </div>
              <p class="mb-1 text-muted">{{ activity.module }}</p>
            </div>
            {% endfor %}
          </div>
        </div>
      </div>

      {% elif report.report_type == 'THREAT_INTEL' %}
      <!-- Threat Intelligence Report Content -->
      <div class="row mb-4">
        <div class="col-md-4 mb-3">
          <div class="card stat-card h-100 bg-danger text-white">
            <div class="card-body">
              <h5 class="card-title">Malware Variants</h5>
              <p class="display-4">
                {{ report.data.malware_intel.emerging_threats|length }}
              </p>
            </div>
          </div>
        </div>
        <div class="col-md-4 mb-3">
          <div class="card stat-card h-100 bg-warning text-dark">
            <div class="card-body">
              <h5 class="card-title">Critical Alerts</h5>
              <p class="display-4">
                {{ report.data.network_intel.critical_alerts|length }}
              </p>
            </div>
          </div>
        </div>
        <div class="col-md-4 mb-3">
          <div class="card stat-card h-100 bg-info text-white">
            <div class="card-body">
              <h5 class="card-title">Threat Correlations</h5>
              <p class="display-4">
                {{ report.data.threat_correlation|length }}
              </p>
            </div>
          </div>
        </div>
      </div>

      <div class="row">
        <div class="col-md-6">
          <div class="card mb-4">
            <div class="card-header">
              <h5 class="mb-0">Emerging Threat Types</h5>
            </div>
            <div class="card-body">
              <div class="chart-container">
                <canvas id="emergingThreatsChart"></canvas>
              </div>
            </div>
          </div>
        </div>
        <div class="col-md-6">
          <div class="card mb-4">
            <div class="card-header">
              <h5 class="mb-0">Common Attack Patterns</h5>
            </div>
            <div class="card-body">
              <div class="chart-container">
                <canvas id="attackPatternsChart"></canvas>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="card mb-4">
        <div class="card-header">
          <h5 class="mb-0">Recent Malware Detections</h5>
        </div>
        <div class="card-body p-0">
          <div class="table-responsive">
            <table class="table table-hover mb-0">
              <thead>
                <tr>
                  <th>Timestamp</th>
                  <th>File Path</th>
                  <th>Malware Type</th>
                  <th>Details</th>
                </tr>
              </thead>
              <tbody>
                {% for malware in report.data.malware_intel.recent_malware %}
                <tr>
                  <td>{{ malware.scan_time|date:"M d, H:i" }}</td>
                  <td>{{ malware.file_path|truncatechars:30 }}</td>
                  <td>
                    <span class="badge bg-danger"
                      >{{ malware.malware_type }}</span
                    >
                  </td>
                  <td>{{ malware.details|truncatechars:50 }}</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <div class="card mb-4">
        <div class="card-header">
          <h5 class="mb-0">Critical Network Alerts</h5>
        </div>
        <div class="card-body p-0">
          <div class="list-group list-group-flush">
            {% for alert in report.data.network_intel.critical_alerts %}
            <div class="list-group-item threat-item">
              <div class="d-flex w-100 justify-content-between">
                <h6 class="mb-1">{{ alert.rule_name }}</h6>
                <small>{{ alert.timestamp|date:"M d, H:i" }}</small>
              </div>
              <div class="d-flex justify-content-between mb-1">
                <span class="text-muted"
                  >{{ alert.src_ip }} â†’ {{ alert.dst_ip }}</span
                >
                <span class="badge bg-secondary">{{ alert.protocol }}</span>
              </div>
              <p class="mb-0">{{ alert.details }}</p>
            </div>
            {% endfor %}
          </div>
        </div>
      </div>

      {% elif report.report_type == 'SYSTEM_SAFETY' %}
      <!-- System Safety Report Content -->
      <div class="row mb-4">
        <div class="col-md-4 mb-3">
          <div class="card stat-card h-100 bg-info text-white">
            <div class="card-body">
              <h5 class="card-title">System Health Score</h5>
              <p class="display-4">
                {% widthratio 100 report.data.system_health.error_rate
                report.data.system_health.log_volume as health_score %} {{
                health_score|floatformat:0 }}%
              </p>
            </div>
          </div>
        </div>
        <div class="col-md-4 mb-3">
          <div class="card stat-card h-100 bg-success text-white">
            <div class="card-body">
              <h5 class="card-title">Protected Assets</h5>
              <p class="display-4">
                {{ report.data.protection_status.malware_detection_rate }}
              </p>
            </div>
          </div>
        </div>
        <div class="col-md-4 mb-3">
          <div class="card stat-card h-100 bg-primary text-white">
            <div class="card-body">
              <h5 class="card-title">Network Sessions</h5>
              <p class="display-4">
                {{ report.data.network_health.capture_sessions }}
              </p>
            </div>
          </div>
        </div>
      </div>

      <div class="row">
        <div class="col-md-6">
          <div class="card mb-4">
            <div class="card-header">
              <h5 class="mb-0">System Log Levels</h5>
            </div>
            <div class="card-body">
              <div class="chart-container">
                <canvas id="logLevelsChart"></canvas>
              </div>
            </div>
          </div>
        </div>
        <div class="col-md-6">
          <div class="card mb-4">
            <div class="card-header">
              <h5 class="mb-0">Protection Status</h5>
            </div>
            <div class="card-body">
              <div class="chart-container">
                <canvas id="protectionChart"></canvas>
              </div>
            </div>
          </div>
        </div>
      </div>

      {% if report.data.recommendations %}
      <div class="section">
        <h2 class="section-title">Security Recommendations</h2>

        {% for rec in report.data.recommendations %}
        <div
          class="recommendation {% if rec.severity == 'critical' %}critical{% else %}high{% endif %}"
        >
          <h3>{{ rec.category }}</h3>
          <p>{{ rec.message }}</p>
          <p>
            <strong>Severity:</strong>
            <span class="badge severity-{{ rec.severity }}"
              >{{ rec.severity|upper }}</span
            >
          </p>
        </div>
        {% endfor %}
      </div>
      {% endif %}

      <div class="card">
        <div class="card-header">
          <h5 class="mb-0">System Metrics</h5>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-6">
              <div class="mb-3">
                <h6>Log Statistics</h6>
                <div class="progress mb-2" style="height: 20px">
                  <div
                    class="progress-bar bg-success"
                    role="progressbar"
                    style="width: {% widthratio report.data.system_health.compression_rate report.data.system_health.log_volume 100 %}%"
                  >
                    Compressed: {{ report.data.system_health.compression_rate }}
                  </div>
                </div>
                <div class="progress" style="height: 20px">
                  <div
                    class="progress-bar bg-danger"
                    role="progressbar"
                    style="width: {% widthratio report.data.system_health.error_rate report.data.system_health.log_volume 100 %}%"
                  >
                    Errors: {{ report.data.system_health.error_rate }}
                  </div>
                </div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="mb-3">
                <h6>Network Statistics</h6>
                <p>
                  Average packets per session: {{
                  report.data.network_health.average_packets|floatformat:0 }}
                </p>
                <p>
                  Active capture sessions: {{
                  report.data.network_health.active_captures }}
                </p>
              </div>
            </div>
          </div>
        </div>
      </div>
      {% endif %}
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      document.addEventListener('DOMContentLoaded', function() {
          const reportData = JSON.parse('{{ report_data|escapejs }}');

          // Common chart configuration
          const chartOptions = {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                  legend: {
                      position: 'bottom',
                  }
              }
          };

          {% if report.report_type == 'THREAT_SUMMARY' %}
              // Malware by type chart
              const malwareTypeCtx = document.getElementById('malwareTypeChart').getContext('2d');
              new Chart(malwareTypeCtx, {
                  type: 'doughnut',
                  data: {
                      labels: reportData.malware.by_type.map(item => item.malware_type || 'Unknown'),
                      datasets: [{
                          data: reportData.malware.by_type.map(item => item.count),
                          backgroundColor: [
                              '#ff6384', '#36a2eb', '#ffce56', '#4bc0c0', '#9966ff',
                              '#ff9f40', '#8ac24a', '#607d8b', '#e91e63', '#00bcd4'
                          ]
                      }]
                  },
                  options: chartOptions
              });

              // Network alerts by severity
              const networkSeverityCtx = document.getElementById('networkSeverityChart').getContext('2d');
              new Chart(networkSeverityCtx, {
                  type: 'bar',
                  data: {
                      labels: reportData.network.by_severity.map(item => item.severity.toUpperCase()),
                      datasets: [{
                          label: 'Alerts',
                          data: reportData.network.by_severity.map(item => item.count),
                          backgroundColor: [
                              '#4bc0c0', '#ffce56', '#ff9f40', '#ff6384'
                          ]
                      }]
                  },
                  options: chartOptions
              });

              // Source IP chart
              const sourceIpCtx = document.getElementById('sourceIpChart').getContext('2d');
              new Chart(sourceIpCtx, {
                  type: 'horizontalBar',
                  data: {
                      labels: reportData.network.top_src_ips.map(item => item.src_ip),
                      datasets: [{
                          label: 'Alerts',
                          data: reportData.network.top_src_ips.map(item => item.count),
                          backgroundColor: '#36a2eb'
                      }]
                  },
                  options: chartOptions
              });

              // Log levels chart
              const logLevelCtx = document.getElementById('logLevelChart').getContext('2d');
              new Chart(logLevelCtx, {
                  type: 'pie',
                  data: {
                      labels: reportData.logs.by_level.map(item => item.level),
                      datasets: [{
                          data: reportData.logs.by_level.map(item => item.count),
                          backgroundColor: [
                              '#8ac24a', '#36a2eb', '#ffce56', '#ff9f40', '#ff6384'
                          ]
                      }]
                  },
                  options: chartOptions
              });

          {% elif report.report_type == 'THREAT_INTEL' %}
              // Emerging threats chart
              const emergingThreatsCtx = document.getElementById('emergingThreatsChart').getContext('2d');
              new Chart(emergingThreatsCtx, {
                  type: 'polarArea',
                  data: {
                      labels: reportData.malware_intel.emerging_threats.map(item => item.malware_type),
                      datasets: [{
                          data: reportData.malware_intel.emerging_threats.map(item => item.count),
                          backgroundColor: [
                              '#ff6384', '#36a2eb', '#ffce56', '#4bc0c0', '#9966ff'
                          ]
                      }]
                  },
                  options: chartOptions
              });

              // Attack patterns chart
              const attackPatternsCtx = document.getElementById('attackPatternsChart').getContext('2d');
              new Chart(attackPatternsCtx, {
                  type: 'radar',
                  data: {
                      labels: reportData.network_intel.common_attack_patterns.map(item => item.rule_name),
                      datasets: [{
                          label: 'Frequency',
                          data: reportData.network_intel.common_attack_patterns.map(item => item.count),
                          backgroundColor: 'rgba(255, 99, 132, 0.2)',
                          borderColor: 'rgba(255, 99, 132, 1)',
                          pointBackgroundColor: 'rgba(255, 99, 132, 1)'
                      }]
                  },
                  options: chartOptions
              });

          {% elif report.report_type == 'SYSTEM_SAFETY' %}
              // Log levels chart
              const logLevelsCtx = document.getElementById('logLevelsChart').getContext('2d');
              new Chart(logLevelsCtx, {
                  type: 'pie',
                  data: {
                      labels: reportData.system_health.log_levels.map(item => item.level),
                      datasets: [{
                          data: reportData.system_health.log_levels.map(item => item.count),
                          backgroundColor: [
                              '#8ac24a', '#36a2eb', '#ffce56', '#ff9f40', '#ff6384'
                          ]
                      }]
                  },
                  options: chartOptions
              });

              // Protection chart
              const protectionCtx = document.getElementById('protectionChart').getContext('2d');
              new Chart(protectionCtx, {
                  type: 'bar',
                  data: {
                      labels: ['Malware Detected', 'IPs Blocked', 'Quarantined Files'],
                      datasets: [{
                          label: 'Count',
                          data: [
                              reportData.protection_status.malware_detection_rate,
                              reportData.protection_status.blocked_threats,
                              reportData.protection_status.quarantine_success
                          ],
                          backgroundColor: [
                              '#4bc0c0', '#9966ff', '#ffce56'
                          ]
                      }]
                  },
                  options: chartOptions
              });
          {% endif %}
      });
    </script>
  </body>
</html>
